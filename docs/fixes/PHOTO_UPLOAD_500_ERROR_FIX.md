# Photo Upload 500 Error - Root Cause & Fix

**Date:** 2026-01-26
**Status:** âœ… FIXED
**Severity:** Production Critical

---

## ðŸ”´ Problem Summary

Camp accounts were unable to upload profile photos, receiving a **500 Internal Server Error** when attempting to upload via `POST /api/upload/camp-photo/:campId`.

### Symptoms

- **Frontend**: File selected correctly (shown in console logs)
  - Filename: unnamed-1.jpg
  - Size: ~293 KB
  - Type: image/jpeg
- **Network Request**: POST /upload/camp-photo/:campId â†’ 500
- **Console**: "Request Data: {}" (misleading - FormData appeared empty)
- **Response**: `{ message: "Something went wrong!" }`

---

## ðŸ” Root Cause Analysis

### Primary Issue: Malformed Content-Type Header

**Location**: `client/src/services/api.ts` - Multiple upload methods

The frontend was manually setting the `Content-Type` header:

```typescript
// âŒ WRONG - Missing boundary parameter
headers: {
  'Content-Type': 'multipart/form-data',
}
```

**Why this breaks uploads:**

When uploading files with FormData, the `Content-Type` header **must** include a boundary parameter:

```
âœ… Correct (auto-generated by browser/Axios):
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

âŒ Wrong (manually set):
Content-Type: multipart/form-data
```

Without the boundary, the server's Multer middleware cannot parse the multipart request:
1. Browser sends FormData with incorrect Content-Type
2. Multer cannot parse the request body
3. Multer throws a parsing error
4. Global error handler catches it and returns generic 500

### Secondary Issue: Missing transformRequest

Some upload methods were missing `transformRequest: [(data) => data]`, which tells Axios not to serialize FormData.

### Tertiary Issue: Misleading Debug Logs

The Axios interceptor was calling `JSON.stringify()` on FormData, which returns `{}`:

```typescript
// âŒ Shows "Request Data: {}" for FormData
console.log('Request Data:', JSON.stringify(config.data, null, 2));
```

This made debugging harder by hiding the actual file being uploaded.

---

## âœ… Solution Implemented

### 1. Fixed All Upload Methods

**Files Fixed:**
- `uploadProfilePhoto()`
- `uploadCampPhoto()` â† Main issue
- `uploadCampPhotos()`
- `uploadAdminCampPhoto()`

**Changes:**
```typescript
// âœ… CORRECT - Let Axios set Content-Type automatically
const response = await this.api.post(url, formData, {
  // Removed: 'Content-Type': 'multipart/form-data'
  transformRequest: [(data) => data], // Don't transform FormData
});
```

### 2. Improved Axios Interceptor Logging

**Before:**
```typescript
if (config.data) {
  console.log('Request Data:', JSON.stringify(config.data, null, 2));
}
```

**After:**
```typescript
if (config.data) {
  // Handle FormData specially
  if (config.data instanceof FormData) {
    console.log('Request Data: FormData with entries:');
    for (const [key, value] of config.data.entries()) {
      if (value instanceof File) {
        console.log(`  - ${key}: File(${value.name}, ${value.size} bytes, ${value.type})`);
      } else {
        console.log(`  - ${key}:`, value);
      }
    }
  } else {
    console.log('Request Data:', JSON.stringify(config.data, null, 2));
  }
}
```

Now shows actual file details instead of empty `{}`.

### 3. Enhanced Backend Error Handling

**Before:**
```javascript
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ message: 'Something went wrong!' });
});
```

**After:**
```javascript
app.use((err, req, res, next) => {
  // Handle Multer errors with specific messages
  if (err.name === 'MulterError') {
    if (err.code === 'LIMIT_FILE_SIZE') {
      return res.status(413).json({ message: 'File too large. Maximum size is 10MB.' });
    }
    if (err.code === 'LIMIT_UNEXPECTED_FILE') {
      return res.status(400).json({ message: 'Unexpected field in upload...' });
    }
    return res.status(400).json({ message: `Upload error: ${err.message}` });
  }
  
  // Other error handling...
  res.status(500).json({ 
    message: 'Something went wrong!',
    ...(process.env.NODE_ENV !== 'production' && { error: err.message })
  });
});
```

Now returns proper 400/413 errors for validation issues instead of generic 500s.

---

## ðŸŽ¯ Expected Behavior After Fix

### Frontend Console Output:
```
ðŸ“¸ Uploading photo: unnamed-1.jpg 293000 bytes image/jpeg
ðŸ“¸ Upload context: camp campId: 69559af8c6168c32100f6c94
ðŸ“¸ Uploading to camp photo endpoint for camp: 69559af8c6168c32100f6c94
ðŸ”„ [API Interceptor] Request: POST /upload/camp-photo/69559af8c6168c32100f6c94
ðŸ”„ [API Interceptor] Request Data: FormData with entries:
  - photo: File(unnamed-1.jpg, 293000 bytes, image/jpeg)
âœ… [API Interceptor] Response: POST /upload/camp-photo/69559af8c6168c32100f6c94
âœ… [API Interceptor] Response Data: {
  "message": "Camp photo uploaded successfully",
  "photo": {
    "url": "https://res.cloudinary.com/...",
    "caption": "",
    "isPrimary": false
  }
}
```

### Backend Console Output:
```
âœ… [requireCampAccount] Camp account authorized: <userId>
ðŸ“¸ [Camp Photo Upload] File uploaded: unnamed-1.jpg 293000 bytes
ðŸ“¸ [Camp Photo Upload] Cloudinary URL: https://res.cloudinary.com/...
âœ… [Camp Photo Upload] Photo added successfully to camp: 69559af8c6168c32100f6c94
```

---

## ðŸ§ª Testing Checklist

- [ ] Camp account uploads profile photo â†’ Success (200)
- [ ] Personal account uploads profile photo â†’ Success (200)
- [ ] Admin uploads camp photo â†’ Success (200)
- [ ] Upload file >10MB â†’ Returns 413 (not 500)
- [ ] Upload non-image file â†’ Returns 400 (not 500)
- [ ] Upload with wrong field name â†’ Returns 400 with clear message
- [ ] Console logs show actual file details (not empty `{}`)

---

## ðŸ“ Related Issues

### Not Related (Secondary Issues):
- `GET /camps/:id/invites/template â†’ 500` - Separate backend issue
- `socket.io polling to localhost:5001` - Local dev environment issue

These were occurring simultaneously but are **unrelated** to the photo upload bug.

---

## ðŸ”‘ Key Takeaways

1. **Never manually set `Content-Type: multipart/form-data`** - Let Axios/browser set it automatically with the boundary
2. **Always use `transformRequest: [(data) => data]`** for FormData uploads
3. **FormData cannot be JSON.stringified** - Handle it specially in logging
4. **Generic 500 errors hide root causes** - Return specific 400/413 errors for validation issues
5. **Global error handlers should differentiate error types** - Multer, validation, CORS, etc.

---

## ðŸ“š Further Reading

- [MDN: FormData](https://developer.mozilla.org/en-US/docs/Web/API/FormData)
- [Axios: File Upload](https://axios-http.com/docs/post_example)
- [Multer Documentation](https://github.com/expressjs/multer)
- [HTTP 400 vs 500 Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
